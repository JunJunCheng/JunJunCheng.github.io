<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Juncheng Zhao"><title>Copy Constructor & Copy Assignment · JunJun</title><meta name="description" content="Class Full Complement of functions12345678910class X&amp;#123;	X(Sometype);			// &quot;ordinary constructor&quot; Create an object	X();					// default constructor	X"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">JunJun</a></h3></div></div><ul class="social-links"></ul><div class="footer"><a target="_blank" href="/"><span>Blog by JunJun</span></a></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Copy Constructor &amp; Copy Assignment</a></h3></div><div class="post-content"><h4 id="Class-Full-Complement-of-functions"><a href="#Class-Full-Complement-of-functions" class="headerlink" title="Class Full Complement of functions"></a>Class Full Complement of functions</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">X</span>&#123;</span></div><div class="line">	X(Sometype);			<span class="comment">// "ordinary constructor" Create an object</span></div><div class="line">	X();					<span class="comment">// default constructor</span></div><div class="line">	X(<span class="keyword">const</span> X&amp;);			<span class="comment">// copy constructor</span></div><div class="line">	X(X&amp;&amp;);				<span class="comment">// move constructor</span></div><div class="line">	X&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> X&amp;);   <span class="comment">// copy assignment: clean up target and copy</span></div><div class="line">	X&amp; <span class="keyword">operator</span>=(X&amp;&amp;);		<span class="comment">// move assignment: clean up target and move</span></div><div class="line">	~X();					<span class="comment">// deconstructor: clean up</span></div><div class="line">	<span class="comment">//...</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>There are five situations in which an object is copied or moved:</p>
<ul>
<li>As the source of an assignment</li>
<li>As an object initializer</li>
<li>As a function argument</li>
<li>As a function return value</li>
<li>As an exception</li>
</ul>
<h4 id="Copy-for-a-class-X-is-defined-by-two-operations"><a href="#Copy-for-a-class-X-is-defined-by-two-operations" class="headerlink" title="Copy for a class X is defined by two operations:"></a>Copy for a class X is defined by two operations:</h4><ul>
<li>Copy constructor: X(const X&amp;)</li>
<li>Copy assignment: X&amp; operator=(const X&amp;)</li>
</ul>
<blockquote>
<p>A copy constructor and a copy assignment differ in that a copy constructor <strong>initializes uninitialized memory</strong>, whereas the copy assignment operator must <strong>correctly deal with an object that has already been constructed and may own resources</strong>.</p>
</blockquote>
<p>对于一个类X, 如果一个构造函数的第一个参数是下列之一:<br>a) X&amp;<br>b) const X&amp;<br>c) volatile X&amp;<br>d) const volatile X&amp;<br>且没有其他参数或其他参数都有默认值,那么这个函数是拷贝构造函数.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span></div><div class="line"><span class="class">&#123;</span></div><div class="line"><span class="keyword">int</span> a;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">	test(<span class="keyword">int</span> b):a(b)&#123;&#125;</div><div class="line">	test(<span class="keyword">const</span> test&amp;);</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span>&#123;<span class="built_in">cout</span> &lt;&lt; a &lt;&lt; <span class="built_in">endl</span>;&#125;</div><div class="line">	~test()&#123;<span class="built_in">cout</span> &lt;&lt; <span class="string">"dtor"</span> &lt;&lt; <span class="built_in">endl</span>;&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">test::test(<span class="keyword">const</span> test&amp; t):a(t.a)&#123;&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">	<span class="function">test <span class="title">t1</span><span class="params">(<span class="number">2</span>)</span></span>;</div><div class="line">	<span class="function">test <span class="title">t2</span><span class="params">(t1)</span></span>;</div><div class="line">	test t3 = t2;</div><div class="line"></div><div class="line">	t1.show();</div><div class="line">	t2.show();</div><div class="line">	t3.show();</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The output is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">2</div><div class="line">2</div><div class="line">2</div><div class="line">dtor</div><div class="line">dtor</div><div class="line">dtor</div></pre></td></tr></table></figure>
<p><code>test(const test&amp;)</code>就是我们自定义的copy constructor。copy constructor 数是一种特殊的constructor，函数的名称必须和类名称一致，它必须的一个参数是本类型的一个引用变量</p>
<p>如果函数中有静态数据成员 <strong>eg:</strong> <code>static int counter;</code>  copy constructor 是没有处理他的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span></div><div class="line"><span class="class">&#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">	test(<span class="keyword">int</span> b):a(b)&#123;counter++;&#125;</div><div class="line">	test(<span class="keyword">const</span> test&amp;);</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">show</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> counter;&#125;</div><div class="line">	~test()&#123;</div><div class="line">		counter--;</div><div class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"dtor "</span> &lt;&lt; counter &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">	&#125;</div><div class="line"><span class="keyword">private</span>:</div><div class="line">	<span class="keyword">int</span> a;</div><div class="line">	<span class="keyword">static</span> <span class="keyword">int</span> counter;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">test::test(<span class="keyword">const</span> test&amp; t):a(t.a)&#123;&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> test::counter = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">	<span class="function">test <span class="title">t1</span><span class="params">(<span class="number">2</span>)</span></span>;</div><div class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"test "</span> &lt;&lt; t1.show() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">	<span class="function">test <span class="title">t2</span><span class="params">(t1)</span></span>;</div><div class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"test "</span> &lt;&lt; t2.show() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Output is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">test 1</div><div class="line">test 1</div><div class="line">dtor 0</div><div class="line">dtor -1</div></pre></td></tr></table></figure>
<p>这里的copy constructor并没有处理<code>static int counter</code> 出现这个问题就是在于 <code>counter</code> 并没有递增。 如果我们改写她的copy constructor，让其变成：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">test::test(<span class="keyword">const</span> test&amp; t):a(t.a)&#123;counter++;&#125;</div></pre></td></tr></table></figure>
<p>Output becomes:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">test 1</div><div class="line">test 2</div><div class="line">dtor 1</div><div class="line">dtor 0</div></pre></td></tr></table></figure>
<p>－ 浅拷贝</p>
<p>所谓浅拷贝，指的是在对象复制时，只对对象中的数据成员进行简单的赋值，默认拷贝构造函数执行的也是浅拷贝。大多情况下“浅拷贝”已经能很好地工作了，但是一旦对象存在了动态成员，那么浅拷贝就会出问题了，让我们考虑如下一段代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rect</span>  </span></div><div class="line"><span class="class">&#123;</span>  </div><div class="line"><span class="keyword">public</span>:  </div><div class="line">    Rect()        </div><div class="line">    &#123;  </div><div class="line">        p = <span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">100</span>);  </div><div class="line">    &#125;  </div><div class="line">    ~Rect()     </div><div class="line">    &#123;  </div><div class="line">        <span class="keyword">if</span>(p != <span class="literal">NULL</span>)  </div><div class="line">        &#123;  </div><div class="line">            <span class="keyword">delete</span> p;  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line"><span class="keyword">private</span>:  </div><div class="line">    <span class="keyword">int</span> width;  </div><div class="line">    <span class="keyword">int</span> height;  </div><div class="line">    <span class="keyword">int</span> *p;      </div><div class="line">&#125;;  </div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span>  </span></div><div class="line"><span class="function"></span>&#123;  </div><div class="line">    Rect rect1;  </div><div class="line">    <span class="function">Rect <span class="title">rect2</span><span class="params">(rect1)</span></span>;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>系统会报错，报错内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">error for object 0x7fe50b400020: pointer being freed was not allocated</div></pre></td></tr></table></figure>
<p>在运行定义rect1对象后，由于在构造函数中有一个动态分配的语句<br><img src="http://img.my.csdn.net/uploads/201102/23/0_1298440885fFHF.gif" alt="dynamic alloc init"><br>在使用rect1复制rect2时，由于执行的是浅拷贝，只是将成员的值进行赋值，这时 rect1.p = rect2.p，也即这两个指针指向了堆里的同一个空间<br><img src="http://img.my.csdn.net/uploads/201102/23/0_1298440940377T.gif" alt="dynamic alloc copy"></p>
<p>这不是我们所期望的结果，在销毁对象时，两个对象的析构函数将对同一个内存空间释放两次，这就是错误出现的原因。我们需要的不是两个p有相同的值，而是两个p指向的空间有相同的值，解决办法就是使用“深拷贝”</p>
<ul>
<li>深拷贝</li>
</ul>
<p>为了解决上面的问题我们写了如下copy constructor:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Rect(<span class="keyword">const</span> Rect&amp; r)&#123;</div><div class="line">    width = r.width;  </div><div class="line">    height = r.height;</div><div class="line">    p = <span class="keyword">new</span> <span class="keyword">int</span>;</div><div class="line">    *p = *(r.p);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://img.my.csdn.net/uploads/201102/23/0_12984409785Oby.gif" alt="dynamic alloc copy"></p>
<p>此时rect1的p和rect2的p各自指向一段内存空间，但它们指向的空间具有相同的内容，这就是所谓的“深拷贝”</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-09-11</span><i class="fa fa-tag"></i></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://yoursite.com/2017/09/11/Copy-Constructor-Copy-Assignment/,JunJun,Copy Constructor &amp; Copy Assignment,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2017/09/12/Virtual-Destructor/" title="Virtual Destructor" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2017/09/11/Effective-C-Note-1/" title="Effective C++ Note (1)" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>